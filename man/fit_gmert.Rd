% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit_gmert.R
\name{fit_gmert}
\alias{fit_gmert}
\title{Fit a generalized mixed-effects regression tree (GMERT)}
\usage{
fit_gmert(
  df,
  id = "id",
  target = "y",
  random_effects = "x1",
  max_iter_inn = 1000,
  max_iter_out = 1000,
  tol = 1e-06,
  cp = 0,
  minsplit = 50,
  minbucket = 20,
  maxdepth = 5,
  xval = 10
)
}
\arguments{
\item{df}{A data frame containing the response, cluster identifier, and predictors.}

\item{id}{Character string. Name of the cluster identifier column in \code{df}.}

\item{target}{Character string. Name of the binary response column in \code{df} (coded 0/1).}

\item{random_effects}{Character string. Name of the predictor used for the random slope.
The random-effects design is built as an intercept plus this column.}

\item{max_iter_inn}{Integer. Maximum number of EM-like inner-loop iterations.}

\item{max_iter_out}{Integer. Maximum number of PQL outer-loop iterations.}

\item{tol}{Numeric scalar. Convergence tolerance used for both inner and outer loops.}

\item{cp}{Numeric scalar. \code{rpart} complexity parameter (pruning threshold).}

\item{minsplit}{Integer. Minimum number of observations required to attempt a split in \code{rpart}.}

\item{minbucket}{Integer. Minimum number of observations in any terminal node in \code{rpart}.}

\item{maxdepth}{Integer. Maximum depth of the fitted \code{rpart} tree.}

\item{xval}{Integer. Number of cross-validation folds used by \code{rpart}.}
}
\value{
A list with components:
\describe{
\item{tree}{An \code{rpart} object: the fitted regression tree for the fixed effects.}
\item{b}{Numeric matrix (G x q) of estimated random effects by cluster.}
\item{D}{Numeric matrix (q x q): estimated random-effects covariance matrix.}
\item{sigma2}{Numeric scalar: estimated residual variance on the working scale.}
\item{mu}{Numeric vector length N: fitted conditional means at convergence.}
\item{converged_in}{Logical vector: inner-loop convergence flag for each outer iteration.}
\item{converged_out}{Logical scalar: outer-loop convergence flag.}
\item{n_iter}{Integer: number of inner iterations performed in the last outer iteration.}
\item{train_ids}{Vector of cluster identifiers from the training data.}
\item{gll}{Numeric vector: generalized log-likelihood trace used for diagnostics.}
\item{tol}{Numeric scalar: tolerance used.}
}
}
\description{
Fits a generalized mixed-effects regression tree model for clustered binary
outcomes using a PQL outer loop and an EM-like inner loop. The fixed part is
estimated via an \code{rpart} regression tree on a working pseudo-response, and the
random part is modeled with cluster-specific random intercepts and slopes
(currently implemented as an intercept plus one random slope).
}
\details{
The function returns a list containing the fitted tree, estimated random
effects, covariance parameters, and convergence diagnostics.

This implementation assumes a binary response and uses a logistic link via a
penalized quasi-likelihood (PQL) linearization. The random-effects structure
is currently an intercept plus one slope specified by \code{random_effects}.
}
\examples{
# Simulate clustered binary data
df <- sim_data_gmert(G = 10, n_i = 30, seed = 1)
split <- split_gmert_data(df, train_prop = 0.7, seed = 1)

# Fit GMERT
fit <- fit_gmert(split$train, id = "id", target = "y", random_effects = "x1",
                 max_iter_inn = 50, max_iter_out = 50, tol = 1e-4,
                 maxdepth = 3, minsplit = 20, minbucket = 10)

# Predict on test set
pred <- predict_gmert(fit, split$test, random_effect = "x1", id = "id")
table(truth = split$test$y, pred = pred)

}
\references{
Hajjem, A., Larocque, D., & Bellavance, F. (2017).
\emph{Generalized mixed effects regression trees}.
Statistics & Probability Letters, 126, 114--118.
\doi{10.1016/j.spl.2017.02.033}
}
\seealso{
\code{\link[=predict_gmert]{predict_gmert()}} for prediction on new data.

Other gmert: 
\code{\link{fit_gmerf_small}()},
\code{\link{fit_gmert_small}()},
\code{\link{predict_gmert}()},
\code{\link{sim_data_gmert}()},
\code{\link{split_gmert_data}()}
}
\concept{gmert}
